<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<title>awwan</title>
		<style>
			.awwan {
				display: flex;
			}
			.awwan_nav_left {
				font-family: monospace;
				height: 98vh;
				overflow-y: auto;
				width: 300px;
			}
			.awwan_content {
				margin: 0 10px;
				width: calc(100% - 330px);
			}
			#vfs_path {
				margin-right: 10px;
			}
			#editor {
				width: 100%;
				height: 600px;
				border: 1px solid silver;
			}
			.editor_action {
				border: 1px solid silver;
				padding: 10px;
			}
			.execute_action {
				margin: 10px 0;
			}
			.boxheader {
				padding: 10px;
				border: 1px solid silver;
			}
			#stdout,
			#stderr {
				font-family: monospace;
				min-height: 200px;
				overflow: auto;
				padding: 10px;
				white-space: pre;
			}
			#stdout {
				background-color: lavender;
				border: 1px solid silver;
			}
			#stderr {
				background-color: lavenderblush;
				border: 1px solid silver;
			}
			@media (max-width: 900px) {
				.awwan {
					display: block;
				}
				.awwan_nav_left {
					min-height: 400px;
					max-height: 400px;
					width: calc(100% - 10px);
				}
				.awwan_content {
					margin: 0;
					width: calc(100% - 10px);
				}
				.editor_action {
					margin: 10px 0;
				}
				#editor {
					height: 400px;
				}
			}
		</style>
	</head>
	<body onload="main()">
		<div class="awwan">
			<div class="awwan_nav_left">
				<div id="vfs"></div>
			</div>
			<div class="awwan_content">
				<div class="editor_action">
					File: <span id="vfs_path">-</span>
					<button onclick="onClickSave()">Save</button>
				</div>
				<div id="editor"></div>
				<div class="execute_action">
					Execute script on
					<button onclick="execLocal()">Local</button>
					or
					<button onclick="execRemote()">Remote</button>
				</div>
				<p>Hints:</p>
				<ul>
					<li>
						Click and drag on the line numbers to select the specific line to be
						executed.
					</li>
					<li>Press ESC to clear selection.</li>
				</ul>
				<div class="boxheader">Standard output:</div>
				<div id="stdout"></div>
				<div class="boxheader">Standard error:</div>
				<div id="stderr"></div>
			</div>
		</div>
		<script>
			var exports = {}
			var comEditor
			var comFilePath = document.getElementById("vfs_path")
			var comStdout
			var comStderr
			var comVfs
			var request = {
				script: "",
				content: "",
				begin_at: 0,
				end_at: 0,
			}
		</script>
		<script src="/vfs.js"></script>
		<script src="/editor.js"></script>
		<script>
			function main() {
				let comVfsOpts = {
					id: "vfs",
					ListNodes: ListNodes,
					OnClickNode: OnClickNode,
				}
				comVfs = new Vfs(comVfsOpts)
				comVfs.init()

				let editorOpts = {
					id: "editor",
					is_editable: true,
					OpenFile: editorOpenFile,
					OnSelection: editorOnSelection,
					OnSave: editorOnSave,
				}
				comEditor = new Editor(editorOpts)

				comStdout = document.getElementById("stdout")
				comStderr = document.getElementById("stderr")
			}

			// ListNodes fetch the list of files from remote server.
			async function ListNodes() {
				let httpRes = await fetch("/awwan/api/fs")
				if (httpRes.status != 200) {
					console.error("ListNodes:", httpRes)
					return nil
				}
				let res = await httpRes.json()
				if (res.code != 200) {
					console.error(res.message)
					return nil
				}
				return res.data
			}

			function OnClickNode(path, is_dir) {
				if (!is_dir) {
					comEditor.OpenFile(path)
				}
				let hash = "#" + path
				if (history.pushState) {
					history.pushState(null, null, hash)
				} else {
					window.location.hash = hash
				}
			}

			function onClickSave() {
				if (request.script == "") {
					return
				}
				let content = comEditor.GetContent()
				let l = content.length
				if (l > 0 && content[l - 1] != "\n") {
					content += "\n"
				}
				request.content = content
				doSaveFile(request.script, request.content)
			}

			function editorOnSave(content) {
				doSaveFile(request.script, content)
			}

			async function editorOpenFile(path) {
				let httpRes = await fetch("/awwan/api/fs?path=" + path)
				if (httpRes.status != 200) {
					console.error("OnClickNode:", httpRes)
					return null
				}
				let res = await httpRes.json()
				if (res.code == 200) {
					comFilePath.innerText = path
					request.script = path
				}
				return res
			}

			async function doSaveFile(path, content) {
				let req = {
					path: path,
					content: btoa(content),
				}
				let httpRes = await fetch("/awwan/api/fs", {
					method: "PUT",
					headers: {
						Accept: "application/json",
						"Content-Type": "application/json",
					},
					body: JSON.stringify(req),
				})
				if (httpRes.status != 200) {
					console.error("doSaveFile:", httpRes)
					return null
				}
				let res = await httpRes.json()
				if (res.code != 200) {
					console.error("doSaveFile:", httpRes)
					return null
				}
				return res
			}

			function editorOnSelection(begin, end) {
				let stmts = comEditor.lines.slice(begin, end + 1)
				for (const stmt of stmts) {
					console.log("stmt:", stmt.x, stmt.text)
				}
			}

			// execLocal request to execute the selected script on local system.
			function execLocal() {
				if (request.script == "") {
					console.log("no file selected")
					return
				}
				httpApiExecute("local")
			}

			// execRemote request to execute the selected script on remote system.
			function execRemote() {
				if (request.script == "") {
					console.log("no file selected")
					return
				}
				httpApiExecute("remote")
			}

			async function httpApiExecute(mode) {
				let selectionRange = comEditor.GetSelectionRange()
				if (selectionRange.BeginAt < 0) {
					request.begin_at = 0
				} else {
					request.begin_at = selectionRange.BeginAt + 1
				}
				if (selectionRange.EndAt < 0) {
					request.end_at = 0
				} else {
					request.end_at = selectionRange.EndAt + 1
				}

				request.mode = mode
				request.content = btoa(comEditor.GetContent())

				let httpRes = await fetch("/awwan/api/execute", {
					method: "POST",
					headers: {
						Accept: "application/json",
						"Content-Type": "application/json",
					},
					body: JSON.stringify(request),
				})

				let res = await httpRes.json()
				if (res.code != 200) {
					console.error(res)
					return
				}

				comStdout.innerText = atob(res.data.stdout)
				if (res.data.stderr) {
					comStderr.innerText = atob(res.data.stderr)
				}
			}
		</script>
	</body>
</html>
