<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<title>awwan</title>
		<style>
			.awwan {
				display: flex;
			}
			.awwan_nav_left {
				font-family: monospace;
				height: 98vh;
				overflow-y: auto;
				width: 300px;
			}
			.awwan_content {
				margin: 0 10px;
				width: calc(100% - 330px);
			}
			#vfs_path {
				margin-right: 10px;
			}
			#editor {
				width: 100%;
				height: 600px;
				border: 1px solid silver;
			}
			.editor_action {
				border: 1px solid silver;
				padding: 10px;
			}
			.execute_action {
				margin: 10px 0;
			}
			.boxheader {
				padding: 10px;
				border: 1px solid silver;
			}
			#stdout,
			#stderr {
				font-family: monospace;
				min-height: 200px;
				overflow: auto;
				padding: 10px;
				white-space: pre;
			}
			#stdout {
				background-color: lavender;
				border: 1px solid silver;
			}
			#stderr {
				background-color: lavenderblush;
				border: 1px solid silver;
			}
			@media (max-width: 900px) {
				.awwan {
					display: block;
				}
				.awwan_nav_left {
					height: 400px;
					width: calc(100% - 10px);
				}
				.awwan_content {
					margin: 0;
					width: calc(100% - 10px);
				}
				.editor_action {
					margin: 10px 0;
				}
				#editor {
					height: 400px;
				}
			}
		</style>
	</head>
	<body onload="main()">
		<div class="awwan">
			<div class="awwan_nav_left">
				<div id="vfs"></div>
			</div>
			<div class="awwan_content">
				<div class="editor_action">
					File: <span id="vfs_path">-</span>
					<button onclick="onClickSave()">Save</button>
				</div>
				<div id="editor"></div>
				<div class="execute_action">
					Execute script on
					<button onclick="execLocal()">Local</button>
					or
					<button onclick="execRemote()">Remote</button>
				</div>
				<p>Hints:</p>
				<ul>
					<li>
						Click and drag on the line numbers to select the specific line to be
						executed.
					</li>
					<li>Press ESC to clear selection.</li>
				</ul>
				<div class="boxheader">Standard output:</div>
				<div id="stdout"></div>
				<div class="boxheader">Standard error:</div>
				<div id="stderr"></div>
			</div>
		</div>
		<script>
			var MAX_FILE_SIZE = 3000000
			var exports = {}
			var com_file_path = document.getElementById("vfs_path")
			var com_stdout
			var com_stderr
			var request = {
				script: "",
				content: "",
				begin_at: 0,
				end_at: 0,
			}
			var wui_editor
			var wui_notif
			var wui_vfs
		</script>
		<script src="/editor.js"></script>
		<script src="/notif.js"></script>
		<script src="/vfs.js"></script>
		<script>
			function main() {
				let editor_opts = {
					id: "editor",
					is_editable: true,
					OnSelection: editorOnSelection,
					OnSave: editorOnSave,
				}
				wui_editor = new WuiEditor(editor_opts)

				wui_notif = new WuiNotif()

				let wui_vfs_opts = {
					id: "vfs",
					Open: Open,
					OpenNode: OpenNode,
				}
				wui_vfs = new WuiVfs(wui_vfs_opts)

				com_stdout = document.getElementById("stdout")
				com_stderr = document.getElementById("stderr")

				window.onhashchange = function (ev) {
					ev.preventDefault()
					let url = new URL(ev.newURL)
					onHashChange(url.hash)
				}

				// Open path based on hash.
				onHashChange(window.location.hash)
			}

			function onHashChange(hash) {
				if (hash === "") {
					hash = "#/"
				}

				hash = hash.substring(1)
				wui_vfs.OpenDir(hash)
			}

			// Open fetch the node content from remote server.
			async function Open(path, is_dir) {
				let http_res = await fetch("/awwan/api/fs?path=" + path)
				let res = await http_res.json()
				if (res.code != 200) {
					wui_notif.Error(`Failed to open ${path}: ${res.message}`)
					return res
				}
				if (is_dir) {
					window.location.hash = "#" + path
					return res
				}

				let resAllow = isEditAllowed(res.data)
				if (resAllow.code != 200) {
					wui_notif.Error(resAllow.message)
					return resAllow
				}

				com_file_path.innerText = path
				request.script = path
				wui_editor.Open(res.data)
				return res
			}

			// OpenNode is an handler that will called when user click on of the
			// item in the list.
			async function OpenNode(node) {
				let resAllow = isEditAllowed(node)
				if (resAllow.code != 200) {
					wui_notif.Error(resAllow.message)
					return resAllow
				}

				return await Open(node.path, node.is_dir)
			}

			function isEditAllowed(node) {
				let res = {
					code: 412,
				}

				let is_type_allowed = false
				if (
					node.content_type.includes("json") ||
					node.content_type.includes("message") ||
					node.content_type.includes("script") ||
					node.content_type.includes("text") ||
					node.content_type.includes("xml")
				) {
					is_type_allowed = true
				}
				if (!is_type_allowed) {
					res.message = `The file "${node.name}" with content type "${node.content_type}" is not allowed to be opened`
					return res
				}
				if (node.size > MAX_FILE_SIZE) {
					res.message = `The file "${node.name}" with size ${
						node.size / 1000000
					}MB is greater than maximum ${MAX_FILE_SIZE / 1000000}MB.`
					return res
				}
				res.code = 200
				return res
			}

			function onClickSave() {
				if (request.script == "") {
					return
				}
				let content = wui_editor.GetContent()
				let l = content.length
				if (l > 0 && content[l - 1] != "\n") {
					content += "\n"
				}
				request.content = content
				doSaveFile(request.script, request.content)
			}

			function editorOnSave(content) {
				doSaveFile(request.script, content)
			}

			async function doSaveFile(path, content) {
				let req = {
					path: path,
					content: btoa(content),
				}
				let http_res = await fetch("/awwan/api/fs", {
					method: "PUT",
					headers: {
						Accept: "application/json",
						"Content-Type": "application/json",
					},
					body: JSON.stringify(req),
				})
				let res = await http_res.json()
				if (res.code != 200) {
					wui_notif.Error(`Failed to save file ${path}: ${res.message}`)
					return null
				}

				wui_notif.Info(`File ${path} has been saved.`)
				return res
			}

			function editorOnSelection(begin, end) {
				let stmts = wui_editor.lines.slice(begin, end + 1)
				for (const stmt of stmts) {
					console.log("stmt:", stmt.x, stmt.text)
				}
			}

			// execLocal request to execute the selected script on local system.
			function execLocal() {
				if (request.script == "") {
					wui_notif.Error(`Execute on local: no file selected`)
					return
				}
				httpApiExecute("local")
			}

			// execRemote request to execute the selected script on remote system.
			function execRemote() {
				if (request.script == "") {
					wui_notif.Error(`Execute on remote: no file selected`)
					return
				}
				httpApiExecute("remote")
			}

			async function httpApiExecute(mode) {
				let selection_range = wui_editor.GetSelectionRange()
				if (selection_range.begin_at < 0) {
					request.begin_at = 0
				} else {
					request.begin_at = selection_range.begin_at + 1
				}
				if (selection_range.end_at < 0) {
					request.end_at = 0
				} else {
					request.end_at = selection_range.end_at + 1
				}

				request.mode = mode
				request.content = btoa(wui_editor.GetContent())

				let http_res = await fetch("/awwan/api/execute", {
					method: "POST",
					headers: {
						Accept: "application/json",
						"Content-Type": "application/json",
					},
					body: JSON.stringify(request),
				})

				let res = await http_res.json()
				if (res.code != 200) {
					wui_notif.Error(`Execute failed: ${res.message}`)
					return
				}

				com_stdout.innerText = atob(res.data.stdout)
				if (res.data.stderr) {
					com_stderr.innerText = atob(res.data.stderr)
				}

				wui_notif.Info(`Successfully execute ${request.script} on ${mode}.`)
			}
		</script>
	</body>
</html>
